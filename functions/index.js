const functions = require('firebase-functions');
const admin = require('firebase-admin');
const nodemailer = require('nodemailer');
const cors = require('cors')({
	origin: true
});

const config = functions.config();
const APP_NAME = config.app.name;
const APP_ORG_EMAIL = config.app.org_email;
const SMTP_HOST = config.smtp.host;
const SMTP_USERNAME = config.smtp.username;
const SMTP_PASSWORD = config.smtp.password;

admin.initializeApp();

let transporter = nodemailer.createTransport({
	host: SMTP_HOST,
	port: 465,
	secure: true,
	auth: {
		user: SMTP_USERNAME,
		pass: SMTP_PASSWORD
	}
});

exports.sendWelcomeEmail = functions.auth.user().onCreate((user_record, context) => {
	const user_display_name = user_record.displayName;
	const user_email = user_record.email;

	html_body = `<html><head></head><body><div style="width:100%;font-family:'open sans','helvetica neue',helvetica,arial,sans-serif;padding:0;Margin:0"><img id="m_7617458566917411667mshidden" src="https://esputnik.com/repository/applications/commons/hidden.png?iid=09B194B0-B306-11EA-BD9E-D9B21EBC644C" alt="" style="display:block;width:0px;height:0px;float:none;opacity:0.0;border:0px solid;margin:0px"> <div style="background-color:#f6f6f6">  <table width="100%" cellspacing="0" cellpadding="0" style="border-collapse:collapse;border-spacing:0px;padding:0;Margin:0;width:100%;height:100%;background-repeat:repeat;background-position:center top"> <tbody><tr style="border-collapse:collapse"> <td valign="top" style="padding:0;Margin:0"> <table class="m_7617458566917411667es-content" cellspacing="0" cellpadding="0" align="center" style="border-collapse:collapse;border-spacing:0px;table-layout:fixed!important;width:100%"> <tbody><tr style="border-collapse:collapse"> <td align="center" style="padding:0;Margin:0"> <table width="600" cellspacing="0" cellpadding="0" bgcolor="#ffffff" align="center" style="border-collapse:collapse;border-spacing:0px;background-color:#ffffff"> <tbody><tr style="border-collapse:collapse"> <td align="left" style="padding:0;Margin:0;padding-top:20px;padding-left:20px;padding-right:20px"> <table width="100%" cellspacing="0" cellpadding="0" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr style="border-collapse:collapse"> <td width="560" valign="top" align="center" style="padding:0;Margin:0"> <table width="100%" cellspacing="0" cellpadding="0" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr style="border-collapse:collapse"> <td align="center" style="padding:0;Margin:0;font-size:0px"><img class="m_7617458566917411667adapt-img" src="https://hnzntn.stripocdn.email/content/guids/CABINET_19da198d37100eb68e7d51861743eda6/images/31592663743021.gif" alt="" style="display:block;border:0;outline:none;text-decoration:none" width="560"></td> </tr> </tbody></table></td> </tr> </tbody></table></td> </tr> <tr style="border-collapse:collapse"> <td align="left" style="padding:0;Margin:0;padding-top:20px;padding-left:20px;padding-right:20px"> <table cellpadding="0" cellspacing="0" width="100%" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr style="border-collapse:collapse"> <td width="560" align="center" valign="top" style="padding:0;Margin:0"> <table cellpadding="0" cellspacing="0" width="100%" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr style="border-collapse:collapse"> <td align="center" style="padding:30px;Margin:0"><p style="Margin:0;font-size:24px;font-family:'open sans','helvetica neue',helvetica,arial,sans-serif;line-height:36px;color:#333333"><strong>Hey ${user_display_name}</strong></p></td> </tr> <tr style="border-collapse:collapse"> <td align="center" style="padding:0;Margin:0"><p style="Margin:0;font-size:16px;font-family:'open sans','helvetica neue',helvetica,arial,sans-serif;line-height:24px;color:#333333">Thank you for registering for Developer Student Clubs OMG. We assure you there wonâ€™t be any disappointment. We have an amazing event planned for you from the 24th to 28th of June. Filled with speakers across multiple domains and also quality industrial speakers.</p></td> </tr> </tbody></table></td> </tr> </tbody></table></td> </tr> <tr style="border-collapse:collapse"> <td align="left" style="padding:0;Margin:0;padding-top:20px;padding-left:20px;padding-right:20px"> <table cellpadding="0" cellspacing="0" width="100%" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr style="border-collapse:collapse"> <td width="560" align="center" valign="top" style="padding:0;Margin:0"> <table cellpadding="0" cellspacing="0" width="100%" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr style="border-collapse:collapse"> <td align="center" class="m_7617458566917411667es-m-txt-c" style="Margin:0;padding-top:10px;padding-bottom:10px;padding-left:10px;padding-right:10px"><span class="m_7617458566917411667es-button-border" style="border-style:solid;border-color:#2cb543;background:#049c59;border-width:0px;display:inline-block;border-radius:6px;width:auto"><a href="https://dscomg.com" class="m_7617458566917411667es-button" style="text-decoration:none;font-family:'open sans','helvetica neue',helvetica,arial,sans-serif;font-size:18px;color:#ffffff;border-style:solid;border-color:#049c59;border-width:10px 20px 10px 20px;display:inline-block;background:#049c59;border-radius:6px;font-weight:bold;font-style:normal;line-height:22px;width:auto;text-align:center" target="_blank">Visit Website</a></span></td> </tr> </tbody></table></td> </tr> </tbody></table></td> </tr> <tr style="border-collapse:collapse"> <td align="left" style="padding:0;Margin:0;padding-top:20px;padding-left:20px;padding-right:20px"> <table cellpadding="0" cellspacing="0" width="100%" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr style="border-collapse:collapse"> <td width="560" align="center" valign="top" style="padding:0;Margin:0"> <table cellpadding="0" cellspacing="0" width="100%" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr style="border-collapse:collapse"> <td align="center" style="padding:30px;Margin:0"><p style="Margin:0;font-size:24px;font-family:'open sans','helvetica neue',helvetica,arial,sans-serif;line-height:36px;color:#333333"><strong>Information for you<span style="color:#a9a9a9"></span></strong></p></td> </tr> </tbody></table></td> </tr> </tbody></table></td> </tr> <tr style="border-collapse:collapse"> <td align="left" style="padding:0;Margin:0;padding-top:20px;padding-left:20px;padding-right:20px">  <table cellpadding="0" cellspacing="0" class="m_7617458566917411667es-left" align="left" style="border-collapse:collapse;border-spacing:0px;float:left"> <tbody><tr style="border-collapse:collapse"> <td width="174" class="m_7617458566917411667es-m-p0r m_7617458566917411667es-m-p20b" align="center" style="padding:0;Margin:0"> <table cellpadding="0" cellspacing="0" width="100%" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr style="border-collapse:collapse"> <td align="center" style="padding:0;Margin:0;font-size:0px"><img src="https://hnzntn.stripocdn.email/content/guids/CABINET_19da198d37100eb68e7d51861743eda6/images/91771592664016620.png" alt="" style="display:block;border:0;outline:none;text-decoration:none" width="99"></td> </tr> <tr style="border-collapse:collapse"> <td align="center" style="Margin:0;padding-top:10px;padding-bottom:10px;padding-left:20px;padding-right:20px;font-size:0"> <table border="0" width="100%" height="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr style="border-collapse:collapse"> <td style="padding:0;Margin:0px;border-bottom:0px solid #cccccc;background:none;height:1px;width:100%;margin:0px"></td> </tr> </tbody></table></td> </tr> <tr style="border-collapse:collapse"> <td align="center" style="padding:0;Margin:0"><p style="Margin:0;font-size:14px;font-family:'open sans','helvetica neue',helvetica,arial,sans-serif;line-height:21px;color:#333333"><strong>Social Media</strong></p></td> </tr> <tr style="border-collapse:collapse"> <td align="center" style="padding:0;Margin:0;padding-top:10px"><p style="Margin:0;font-size:12px;font-family:'open sans','helvetica neue',helvetica,arial,sans-serif;line-height:14px;color:#333333">We have our social media channels where we would be updating exciting information about the events and speakers</p></td> </tr> </tbody></table></td> <td class="m_7617458566917411667es-hidden" width="20" style="padding:0;Margin:0"></td> </tr> </tbody></table>  <table cellpadding="0" cellspacing="0" class="m_7617458566917411667es-left" align="left" style="border-collapse:collapse;border-spacing:0px;float:left"> <tbody><tr style="border-collapse:collapse"> <td width="173" class="m_7617458566917411667es-m-p20b" align="center" style="padding:0;Margin:0"> <table cellpadding="0" cellspacing="0" width="100%" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr style="border-collapse:collapse"> <td align="center" style="padding:0;Margin:0;font-size:0px"><img src="https://hnzntn.stripocdn.email/content/guids/CABINET_19da198d37100eb68e7d51861743eda6/images/74681592664164818.png" alt="" style="display:block;border:0;outline:none;text-decoration:none" width="99"></td> </tr> <tr style="border-collapse:collapse"> <td align="center" style="Margin:0;padding-top:10px;padding-bottom:10px;padding-left:20px;padding-right:20px;font-size:0"> <table border="0" width="100%" height="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr style="border-collapse:collapse"> <td style="padding:0;Margin:0px;border-bottom:0px solid #cccccc;background:none;height:1px;width:100%;margin:0px"></td> </tr> </tbody></table></td> </tr> <tr style="border-collapse:collapse"> <td align="center" style="padding:0;Margin:0"><p style="Margin:0;font-size:14px;font-family:'open sans','helvetica neue',helvetica,arial,sans-serif;line-height:21px;color:#333333"><strong>Where to attend</strong></p></td> </tr> <tr style="border-collapse:collapse"> <td align="center" style="padding:0;Margin:0;padding-top:10px"><p style="Margin:0;font-size:12px;font-family:'open sans','helvetica neue',helvetica,arial,sans-serif;line-height:14px;color:#333333"> The sessions will be hosted live on our website with a super interactive dashboard ready for you all to have fun at!</p></td> </tr> </tbody></table></td> </tr> </tbody></table>  <table cellpadding="0" cellspacing="0" class="m_7617458566917411667es-right" align="right" style="border-collapse:collapse;border-spacing:0px;float:right"> <tbody><tr style="border-collapse:collapse"> <td width="173" align="center" style="padding:0;Margin:0"> <table cellpadding="0" cellspacing="0" width="100%" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr style="border-collapse:collapse"> <td align="center" style="padding:0;Margin:0;font-size:0px"><img src="https://hnzntn.stripocdn.email/content/guids/CABINET_19da198d37100eb68e7d51861743eda6/images/77961592664169891.png" alt="" style="display:block;border:0;outline:none;text-decoration:none" width="99"></td> </tr> <tr style="border-collapse:collapse"> <td align="center" style="Margin:0;padding-top:10px;padding-bottom:10px;padding-left:20px;padding-right:20px;font-size:0"> <table border="0" width="100%" height="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr style="border-collapse:collapse"> <td style="padding:0;Margin:0px;border-bottom:0px solid #cccccc;background:none;height:1px;width:100%;margin:0px"></td> </tr> </tbody></table></td> </tr> <tr style="border-collapse:collapse"> <td align="center" style="padding:0;Margin:0"><p style="Margin:0;font-size:14px;font-family:'open sans','helvetica neue',helvetica,arial,sans-serif;line-height:21px;color:#333333"><strong>Schedule</strong></p></td> </tr> <tr style="border-collapse:collapse"> <td align="center" style="padding:0;Margin:0;padding-top:10px"><p style="Margin:0;font-size:12px;font-family:'open sans','helvetica neue',helvetica,arial,sans-serif;line-height:14px;color:#333333">The schedule will be updated a day before the start of Developer Student Clubs OMG (24th June 2020) on the website.</p></td> </tr> </tbody></table></td> </tr> </tbody></table> </td> </tr> <tr style="border-collapse:collapse"> <td align="left" style="padding:0;Margin:0;padding-top:20px;padding-left:20px;padding-right:20px"> <table cellpadding="0" cellspacing="0" width="100%" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr style="border-collapse:collapse"> <td width="560" align="center" valign="top" style="padding:0;Margin:0"> <table cellpadding="0" cellspacing="0" width="100%" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr style="border-collapse:collapse"> <td align="center" style="padding:20px;Margin:0;font-size:0"> <table border="0" width="100%" height="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr style="border-collapse:collapse"> <td style="padding:0;Margin:0px 0px 0px 0px;border-bottom:1px solid #cccccc;background:none;height:1px;width:100%;margin:0px"></td> </tr> </tbody></table></td> </tr> <tr style="border-collapse:collapse"> <td style="padding:0;Margin:0"> <table cellpadding="0" cellspacing="0" width="100%" class="m_7617458566917411667es-menu" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr style="border-collapse:collapse"> <td align="center" valign="top" width="50%" id="m_7617458566917411667esd-menu-id-0" style="Margin:0;padding-left:5px;padding-right:5px;padding-top:13px;padding-bottom:13px;border:0"><a href="https://instagram.com/omgdsc" style="font-family:'open sans','helvetica neue',helvetica,arial,sans-serif;font-size:16px;text-decoration:none;display:block;color:#333333" target="_blank"><img src="https://hnzntn.stripocdn.email/content/guids/CABINET_19da198d37100eb68e7d51861743eda6/images/64221592664508292.png" alt="Instagram" title="Instagram" align="absmiddle" height="30" style="display:inline-block!important;border:0;outline:none;text-decoration:none;padding-bottom:5px"><br>Instagram</a></td> <td align="center" valign="top" width="50%" id="m_7617458566917411667esd-menu-id-1" style="Margin:0;padding-left:5px;padding-right:5px;padding-top:13px;padding-bottom:13px;border:0"><a href="https://twitter.com/omgdsc" style="font-family:'open sans','helvetica neue',helvetica,arial,sans-serif;font-size:16px;text-decoration:none;display:block;color:#333333" target="_blank"><img src="https://hnzntn.stripocdn.email/content/guids/CABINET_19da198d37100eb68e7d51861743eda6/images/42761592664543804.png" alt="Twitter" title="Twitter" align="absmiddle" height="30" style="display:inline-block!important;border:0;outline:none;text-decoration:none;padding-bottom:5px"><br>Twitter</a></td> </tr> </tbody></table></td> </tr> <tr style="border-collapse:collapse"> <td align="center" style="padding:20px;Margin:0;font-size:0"> <table border="0" width="100%" height="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr style="border-collapse:collapse"> <td style="padding:0;Margin:0px 0px 0px 0px;border-bottom:1px solid #cccccc;background:none;height:1px;width:100%;margin:0px"></td> </tr> </tbody></table></td> </tr> <tr style="border-collapse:collapse"> <td align="center" style="padding:0;Margin:0"><p style="Margin:0;font-size:16px;font-family:'open sans','helvetica neue',helvetica,arial,sans-serif;line-height:24px;color:#333333">Your goto place for information would be the Developer Student Clubs OMG website so just a reminder to keep it bookmarked ðŸ˜‰<br><br>Weâ€™ll keep dropping you short reminders over the mail so be ready to witness the Developer Student Clubs OMG in all its glory.</p></td> </tr> <tr style="border-collapse:collapse"> <td align="center" style="padding:20px;Margin:0;font-size:0"> <table border="0" width="100%" height="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr style="border-collapse:collapse"> <td style="padding:0;Margin:0px 0px 0px 0px;border-bottom:1px solid #cccccc;background:none;height:1px;width:100%;margin:0px"></td> </tr> </tbody></table></td> </tr> <tr style="border-collapse:collapse"> <td align="center" style="Margin:0;padding-top:15px;padding-bottom:15px;padding-left:20px;padding-right:20px;font-size:0"> <table border="0" width="100%" height="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr style="border-collapse:collapse"> <td style="padding:0;Margin:0px;border-bottom:0px solid #cccccc;background:none;height:1px;width:100%;margin:0px"></td> </tr> </tbody></table></td> </tr> <tr style="border-collapse:collapse"> <td align="center" style="padding:0;Margin:0"><p style="Margin:0;font-size:12px;font-family:'open sans','helvetica neue',helvetica,arial,sans-serif;line-height:18px;color:#d3d3d3">You are receiving this email because you have registered for Developer Student Clubs OMG at <a href="http://dscomg.com" target="_blank">dscomg.com</a> using your <a href="mailto:${user_email}">${user_email}</a> email. For any queries reach out to <a href="mailto:hello@dscomg.com" target="_blank">hello@dscomg.com</a></p></td> </tr> </tbody></table></td> </tr> </tbody></table></td> </tr> <tr style="border-collapse:collapse"> <td align="left" style="padding:0;Margin:0;padding-top:20px;padding-left:20px;padding-right:20px"> <table cellpadding="0" cellspacing="0" width="100%" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr style="border-collapse:collapse"> <td width="560" align="center" valign="top" style="padding:0;Margin:0"> <table cellpadding="0" cellspacing="0" width="100%" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr style="border-collapse:collapse"> <td align="center" style="padding:0;Margin:0;font-size:0px"><img class="m_7617458566917411667adapt-img" src="https://hnzntn.stripocdn.email/content/guids/CABINET_19da198d37100eb68e7d51861743eda6/images/58561592664720034.png" alt="" style="display:block;border:0;outline:none;text-decoration:none" width="560"></td> </tr> </tbody></table></td> </tr> </tbody></table></td> </tr> </tbody></table></td> </tr> </tbody></table></td> </tr> </tbody></table> </div> </div></body></html>`;

	return sendWelcomeEmail(user_email, html_body);
});

async function sendWelcomeEmail(user_email, html_body) {
	const mailOptions = {
		from: `${APP_NAME} <${APP_ORG_EMAIL}>`,
		to: user_email,
		subject: `Welcome to Developer Student Clubs OMG`,
		html: html_body
	};
	await transporter.sendMail(mailOptions, (error, info) => {
		if (error)
			console.log(`Error details: ${error} | Info: ${info}`);
		else
			console.log(`Welcome email sent to: ${user_email}`);
	});

	return null;
}

